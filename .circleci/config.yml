version: 2.1

# CircleCI configuration for Google Ads Transparency Scraper
# Two workflows: one for each bottom-to-top agent

orbs:
  node: circleci/node@5.1.0

parameters:
  sheet_name:
    type: string
    default: "Test data"
  run_agent_bottom:
    type: boolean
    default: true
  run_agent_copy_bottom:
    type: boolean
    default: true

jobs:
  # Job for unified_agent_bottom.js (based on unified_agent.js)
  run-unified-agent-bottom:
    docker:
      - image: cimg/node:18.0
    resource_class: medium
    working_directory: ~/project
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
      
      - run:
          name: Install system dependencies for Puppeteer
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              libgbm1 \
              libasound2t64 \
              libnss3 \
              libxss1 \
              libatk-bridge2.0-0 \
              libgtk-3-0 \
              libxshmfence1 \
              fonts-liberation \
              libappindicator3-1 \
              xdg-utils
      
      - run:
          name: Install npm dependencies
          command: npm ci
      
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}
      
      - run:
          name: Create credentials file
          command: |
            echo "$GOOGLE_CREDENTIALS" > credentials.json
      
      - run:
          name: Run Unified Agent Bottom (unified_agent_bottom.js)
          command: |
            echo "ðŸš€ Starting UNIFIED Google Ads Agent (BOTTOM TO TOP) at $(date)"
            echo "ðŸ“Š System environment: $(uname -a)"
            node unified_agent_bottom.js
          environment:
            SHEET_NAME: << pipeline.parameters.sheet_name >>
            CONCURRENT_PAGES: ${CONCURRENT_PAGES:-8}
            BATCH_DELAY_MIN: ${BATCH_DELAY_MIN:-3000}
            BATCH_DELAY_MAX: ${BATCH_DELAY_MAX:-6000}
            PROXIES: ${PROXIES:-}
            MAX_PROXY_ATTEMPTS: ${MAX_PROXY_ATTEMPTS:-}
            PROXY_RETRY_DELAY_MIN: ${PROXY_RETRY_DELAY_MIN:-}
            PROXY_RETRY_DELAY_MAX: ${PROXY_RETRY_DELAY_MAX:-}
            PUPPETEER_EXECUTABLE_PATH: ${PUPPETEER_EXECUTABLE_PATH:-}
      
      - run:
          name: Cleanup credentials
          command: rm -f credentials.json
          when: always
      
      - store_artifacts:
          path: ~/project
          when: on_failure
          destination: error-logs

  # Job for unified_agent_copy_bottom.js (based on unified_agent copy.js)
  run-unified-agent-copy-bottom:
    docker:
      - image: cimg/node:18.0
    resource_class: medium
    working_directory: ~/project
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
      
      - run:
          name: Install system dependencies for Puppeteer
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              libgbm1 \
              libasound2t64 \
              libnss3 \
              libxss1 \
              libatk-bridge2.0-0 \
              libgtk-3-0 \
              libxshmfence1 \
              fonts-liberation \
              libappindicator3-1 \
              xdg-utils
      
      - run:
          name: Install npm dependencies
          command: npm ci
      
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}
      
      - run:
          name: Create credentials file
          command: |
            echo "$GOOGLE_CREDENTIALS" > credentials.json
      
      - run:
          name: Run Unified Agent Copy Bottom (unified_agent_copy_bottom.js)
          command: |
            echo "ðŸš€ Starting UNIFIED Google Ads Agent Copy (BOTTOM TO TOP) at $(date)"
            echo "ðŸ“Š System environment: $(uname -a)"
            node unified_agent_copy_bottom.js
          environment:
            SHEET_NAME: << pipeline.parameters.sheet_name >>
            SHEET_BATCH_SIZE: ${SHEET_BATCH_SIZE:-1000}
            CONCURRENT_PAGES: ${CONCURRENT_PAGES:-5}
            BATCH_DELAY_MIN: ${BATCH_DELAY_MIN:-5000}
            BATCH_DELAY_MAX: ${BATCH_DELAY_MAX:-10000}
            PAGE_LOAD_DELAY_MIN: ${PAGE_LOAD_DELAY_MIN:-1000}
            PAGE_LOAD_DELAY_MAX: ${PAGE_LOAD_DELAY_MAX:-3000}
            PROXIES: ${PROXIES:-}
            MAX_PROXY_ATTEMPTS: ${MAX_PROXY_ATTEMPTS:-}
            PROXY_RETRY_DELAY_MIN: ${PROXY_RETRY_DELAY_MIN:-}
            PROXY_RETRY_DELAY_MAX: ${PROXY_RETRY_DELAY_MAX:-}
            PUPPETEER_EXECUTABLE_PATH: ${PUPPETEER_EXECUTABLE_PATH:-}
      
      - run:
          name: Cleanup credentials
          command: rm -f credentials.json
          when: always
      
      - store_artifacts:
          path: ~/project
          when: on_failure
          destination: error-logs

workflows:
  version: 2
  
  # Workflow to run both bottom-to-top agents
  run-bottom-to-top-agents:
    jobs:
      - run-unified-agent-bottom:
          filters:
            branches:
              only: main
      - run-unified-agent-copy-bottom:
          filters:
            branches:
              only: main
  
  # Workflow to run only unified_agent_bottom.js
  run-agent-bottom-only:
    jobs:
      - run-unified-agent-bottom:
          filters:
            branches:
              only: main
  
  # Workflow to run only unified_agent_copy_bottom.js
  run-agent-copy-bottom-only:
    jobs:
      - run-unified-agent-copy-bottom:
          filters:
            branches:
              only: main
